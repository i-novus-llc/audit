<?xml version='1.0' encoding='UTF-8'?>
<page xmlns="http://n2oapp.net/framework/config/schema/page-2.0" name="Журнал авторизаций, сессий и неудачных попыток входа">

    <regions>
        <region place="single">
            <table id="audit_table" query-id="auditAuthorization" size="10">
                <toolbar>
                    <button id="export" label="Выгрузить" icon="fa fa-download" model="filter">
                        <a href="${audit.export.url}/audit/export" target="newWindow">
                            <query-param name="auditType" value="3"/>
                            <query-param name="eventDateFrom" value="{moment(period.begin, 'YYYY-MM-DDTHH:mm:ss').format('YYYY-MM-DDTHH:mm:ss')}"/>
                            <query-param name="eventDateTo" value="{moment(period.end, 'YYYY-MM-DDTHH:mm:ss').format('YYYY-MM-DDTHH:mm:ss')}"/>
                            <query-param name="username" value="{username}"/>
                            <query-param name="eventType" value="{auditEventTypes*.name}"/>
                        </a>
                    </button>
                </toolbar>
                <filters>
                    <row>
                        <date-interval id="period" label="Дата и время" required="true" time-format="HH:mm" date-format="DD.MM.YYYY">
                            <default-value begin="{moment().startOf('month').format('YYYY-MM-DDTHH:mm:ss')}"
                                           end="{moment().format('YYYY-MM-DDTHH:mm:ss')}"/>
                            <validations>
                                <condition id="checkDate" severity="danger" side="client,server" server-moment="before-query"
                                           message="Укажите даты с интервалом не более 31 дня"
                                           src="/META-INF/js/validation.js"/>
                            </validations>
                        </date-interval>
                        <input-text id="username" label="Пользователь" domain="string"/>
                        <input-select id="auditEventTypes" label="Событие" type="multi" query-id="auditEventType"
                                      label-field-id="name">
                            <pre-filters>
                                <eq field-id="auditTypeId" value="3"/>
                            </pre-filters>
                        </input-select>
                    </row>
                    <hidden id="days_count">
                        <dependencies>
                            <set-value on="period" apply-on-init="true">
                                var period_begin = moment(period.begin, ["YYYY-MM-DD'T'HH:mm:ss"]);
                                var period_end = moment(period.end, ["YYYY-MM-DD'T'HH:mm:ss"]);
                                return period_end.diff(period_begin, 'days');
                            </set-value>
                        </dependencies>
                    </hidden>
                </filters>
                <columns>
                    <column text-field-id="eventDate" label="Дата и время" width="200px"
                            sorting-direction="desc" sorting-field-id="eventDate"/>
                    <column text-field-id="id" label="Идентификатор события"/>
                    <column text-field-id="username" label="Пользователь"/>
                    <column text-field-id="eventType" label="Событие"/>
                    <column text-field-id="contextGrid" label="Данные"/>
                </columns>
                <rows>
                    <click>
                        <show-modal page-id="auditAuthorizationForm" master-field-id="id" detail-field-id="id"/>
                    </click>
                </rows>
                <pre-filters>
                    <eq field-id="auditTypeId" value="3"/>
                </pre-filters>
            </table>
        </region>
    </regions>

</page>
